# **Fabric Data: Secured-By-Design** 



## The Logical Unit 

Most database management systems store data in silos, organized according to the type of data being stored (e.g. customer data, financial data, address data, device data). When data is needed, hundreds or thousands of tables may need to be queried using complex joins to deliver the information. The process is very cumbersome, complex and time consuming. 
Most importantly, data safety is challenged and security is increasingly compromised each time these tables are accessed. Fabric's unique data approach offers a new paradigm for data management especially when it comes to protecting data integrity. Indeed, Fabric organizes and stores data very differently all together. 

Storing data by using an entity-centric pre-defined structure, re-inforce consisderably its security and integrity. This is yet another crucial and unparalelled advantage that Fabric adds in addition to other benefits such as very fast access and high availability of the data. 


## Logical Unit Encryption 

Fabric encrypts each Logical Unit Instance (LUI) using a AES256 algorithm and creates a unique encryption key for each LUI. The LUI data can only be read by using Fabric master key which is also always encrypted. 

This additional atomic-level encryption delivers greater protection for sensitive data and entirely eliminates the chance of a large-scale data breach of your systems. Each entity is uniquely protected and its encryption secrets are not relevant to the other millions or more of entities stored in Fabric.   


## Fabric Hashing Mechanism

Fabric masking mechanism uses the SHA-256 algorithm for hashing data. 

For example:

- An Instance Key used to encrypt LU Instances is the hashed combination of the LU name it belongs to, its own LU Instance, and the master key.
- Fabric masking utility uses the SHA-256 algorithm when hashing the original value of any encrypted field of a given LUI.


## Fabric Project Encryption

The following illustration shows how Logical Units Instances inherit their own private encryption key based on Fabric master key and the LU to which they belong.

<img src="/articles/26_fabric_security/images/02_fabric_encryption_process.png">



### Fabric Master Key 

#### Master Key Generation

Fabric generates its master key using Java built-in methods for AES-256 with GCM (Galois/Counter Mode) keys generation algorithms. 
The master key can be generated by Fabric, or by using the manual Fabric command, and is encrypted using the protection key. 

Once the new Master Key is generated, it is broken into bytes. Each byte is stored in a separate record in a dedicated Cassandra table. Using Cassandra distribution data logic, the parts of the key are stored across different nodes of the Cluster. 

The master key is encrypted using the protection key:
- JAVA_AES library generates a new key using an AES-256 algorithm of size 256 bit. 
- The key generation is based on secured random generation.
- Fabric uses AES-256 algorithm as well as Initialization Vector algorithm, to encrypt the master key.


#### Master Key Storage

Fabric supports a generation of master key with or without the keystore mechanism. 

**w/ keystore**
If you want to use a keystore to hold the protection key of the master key, set the ```MASTERKEY_KEY_STORE_ENABLED``` parameter of your config.ini file to ```true```.

**w/o keystore**
Fabric enables a generation of a master key even if no keystore is installed on your Fabric. A new protection key is generated for each master key. 
When Fabric starts for the first time, a default master key is generated.

A keystore can be added later and the master key will be re-generated using the protection key of the keystore. 
Please note that once the keystore is added to Fabric, it cannot be removed


#### Protection Key Storage

Fabric setup must use Java keytool to create a keystore, which contains an AES-256 key. This is the protection key.
The keystore is locked by a password and is copied to each node of the Fabric cluster.
When starting Fabric, the user must key-in the password of the keystore otherwise Fabric cannot start.

When a new master key is generated, the master key store opens the keystore, gets the protection key stored in the keystore, and uses it with an initialization vector (IV) to encrypt the master key of Fabric. 
The keystore contains the history of all encryptions. Each encryption of a master key creates a record in the keystore with the protection key and the key description of the encrypted master key. This way, when users change the protection key in the keystore, the old protection key can still be used to get entities already encrypted with the previous protection key. 



### Master Key Commands

The key is generated from Performed by using Fabric command - activate key. The activate key command activates 2 components:
o	Key generator
o	Master key store

A key is generated by using the following command:
```activatekey name='<name>' [generatorType='<generatorType>'] [storeType='<storeType>'] [WITH ARGS='<args>']```

e.g.
```activatekey name='keyProjectX' [generatorType='Java_AES'] [storeType='Stripe_AES']```


### Master Key Rotation

Master key rotation enables generating and activating a new master key. The new master key impacts instance IDs saved in Cassandra from the moment it was generated onwards. The already existing instance IDs are not impacted by the new key, until they are next sync-ed and saved on Cassandra.

Upon retrieval of a specific instance ID, K2View Fabric collects the information of the Master Key that was used for the encryption of the LU instance and performs on the fly the de-encryption of the data.



[![Previous](/articles/images/Previous.png)](/articles/26_fabric_security/01_fabric_security_overview.md)[<img align="right" width="60" height="54" src="/articles/images/Next.png">](/articles/26_fabric_security/03_fabric_LUI_encryption.md)
